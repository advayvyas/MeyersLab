---
title: "Week 3"
author: "Advay Vyas"
date: "4/22/25"
output:
  pdf_document:
    toc: true
urlcolor: blue
linkcolor: red
---

```{r global_options, echo=FALSE}
knitr::opts_chunk$set(fig.height=8, fig.width=8, fig.align = "center", warning=FALSE, echo=FALSE, tidy=TRUE, tidy.opts=list(width.cutoff=60))
```

------------------------------------------------------------------------

```{r, results='hide', warning=FALSE, message=FALSE}
library(dplyr)
library(tidyverse)
library(ggplot2)
library(lubridate)
library(patchwork)
```

# Introduction
This week, we want to understand disparities in flu patients by city with the help of normalization. From our very helpful population dataset, we'll take a look at major Texas cities and identify any trends. Perhaps, we can investigate flu season by flu season in time-series data as well as looking at qualitative explanations for the rise in flu patients. I'll also look at temperature data and try to graph that data over time and space (https://www.weather.gov/wrh/climate?wfo=ewx) and I'll also take a look at healthcare metrics like one from the City Health Dashboard and I also want to maybe find a dataset that holds Texas flu vaccinations by city.

\newpage

# Normalizing flu data by population

```{r, results='hide', warning=FALSE, message=FALSE}
library(dplyr)
library(tidyverse)
library(ggplot2)
library(lubridate)
```

```{r}
facility = read.csv("../DSHS/thcic-ids_city_county_crosswalk.csv")
facility_filtered = facility %>%
  group_by(THCIC_ID) %>%
  filter(YEAR == max(YEAR)) %>%
  ungroup()

TX_zip_zcta_pop_city = read.csv("../DSHS/TX_zip_zcta_pop_city.csv")
TX_zcta_pop_city = TX_zip_zcta_pop_city %>%
  select(zcta, City, population) %>%
  distinct() %>%
  group_by(City) %>%
  summarise(population = sum(population))

County = read.csv("../DSHS/county_fips_us.csv")
```

```{r}
flu22_3 = read.csv("../DSHS/FLU_ALL_PAT_CAT_2022Q3.csv")
flu22_4 = read.csv("../DSHS/FLU_ALL_PAT_CAT_2022Q4.csv")
flu23_1 = read.csv("../DSHS/FLU_ALL_PAT_CAT_2023Q1.csv")
flu23_2 = read.csv("../DSHS/FLU_ALL_PAT_CAT_2023Q2.csv")
flu23_3 = read.csv("../DSHS/FLU_ALL_PAT_CAT_2023Q3.csv")
flu23_4 = read.csv("../DSHS/FLU_ALL_PAT_CAT_2023Q4.csv")
flu24_1 = read.csv("../DSHS/FLU_ALL_PAT_CAT_2024Q1.csv")
flu24_2 = read.csv("../DSHS/FLU_ALL_PAT_CAT_2024Q2.csv")
```

```{r}
flu_all_pat_filter = function(flu1){
  flu11 = flu1 %>%
    select(THCIC_ID, PAT_STATE, PAT_ZIP, PAT_COUNTRY, PAT_COUNTY) %>%
    mutate(PAT_ZIP = ifelse(nchar(PAT_ZIP) < 5 | grepl("\\D", PAT_ZIP), NA, PAT_ZIP)) %>%
    mutate(
      PAT_COUNTY_FIPS = str_pad(PAT_COUNTY, width = 3, side = "left", pad = "0"),
      PAT_COUNTY_FIPS = paste0("48", PAT_COUNTY_FIPS)
    ) %>%
    mutate(PAT_COUNTY_FIPS = as.integer(PAT_COUNTY_FIPS),
           PAT_ZIP = as.integer(PAT_ZIP)) %>%
    left_join(County, by = c("PAT_COUNTY_FIPS" = "FIPS")) %>%
    rename(PAT_County = County) %>%
    select(-State.Abbreviation, -State.Name, -FIPS_int, -PAT_COUNTRY) %>%
    left_join(TX_zip_zcta_pop_city, by = c("PAT_ZIP" = "ZIP_CODE", "PAT_STATE" = "STATE")) %>%
    rename(PAT_zcta = zcta, 
           PAT_City = City, 
           PAT_PO_NAME = PO_NAME,
           PAT_population = population) 
  
  flu12 = flu11 %>%
    left_join(facility_filtered, by = "THCIC_ID") %>%
    select(-HOSP_NAME, -HOSP_NAME_clean) %>%
    filter(!is.na(HOSP_CITY) & !is.na(PAT_City)) 
  return(flu12)
}
```

```{r warning = FALSE}
flu22_3_prop = flu_all_pat_filter(flu22_3)
flu22_4_prop = flu_all_pat_filter(flu22_4)
flu23_1_prop = flu_all_pat_filter(flu23_1)
flu23_2_prop = flu_all_pat_filter(flu23_2)
flu23_3_prop = flu_all_pat_filter(flu23_3)
flu23_4_prop = flu_all_pat_filter(flu23_4)
flu24_1_prop = flu_all_pat_filter(flu24_1)
flu24_2_prop = flu_all_pat_filter(flu24_2)

# Add quarter tag and combine
flu22_3_prop$year = 2022
flu22_3_prop$quarter = "2022Q3"

flu22_4_prop$year = 2022
flu22_4_prop$quarter = "2022Q4"

flu23_1_prop$year = 2023
flu23_1_prop$quarter = "2023Q1"

flu23_2_prop$year = 2023
flu23_2_prop$quarter = "2023Q2"

flu23_3_prop$year = 2023
flu23_3_prop$quarter = "2023Q3"

flu23_4_prop$year = 2023
flu23_4_prop$quarter = "2023Q4"

flu24_1_prop$year = 2024
flu24_1_prop$quarter = "2024Q1"

flu24_2_prop$year = 2024
flu24_2_prop$quarter = "2024Q2"

flu24_1_prop$year = 2024
flu24_2_prop$quarter = "2024Q2"

flu_all_labeled = bind_rows(
  flu22_3_prop, flu22_4_prop,
  flu23_1_prop, flu23_2_prop,
  flu23_3_prop, flu23_4_prop,
  flu24_1_prop, flu24_2_prop
)
```

```{r}
city_trend = flu_all_labeled %>%
  filter(PAT_STATE == "TX") %>%
  group_by(PAT_City, year, quarter) %>%
  summarise(total_patients = n(), .groups = "drop")

# Focus on major cities
major_cities = c("Houston", "San Antonio", "Dallas", "Austin", "Fort Worth", "El Paso", "Arlington", "Corpus Christi")
```

```{r}
pop_data_24 <- data.frame(
  year = 2024,
  City = c("Houston", "San Antonio", "Dallas", "Fort Worth", "Austin", 
           "El Paso", "Arlington", "Corpus Christi"),
  population = c(2319119, 1513974, 1302753, 996756, 984567, 678859, 399825, 316105)
)

# gotta clean up this data
city_pop = read.csv("../texas_city_pop.csv")
city_pop = city_pop[c(3:1233), c(1, 3:6)]

names(city_pop) = as.character(city_pop[1, ])
names(city_pop)[1] = "City"
city_pop = city_pop[-1, ]

city_pop = city_pop[c(52, 270, 44, 237, 340, 972, 497, 376),]
city_pop$City = c("Austin", "Dallas", "Arlington", "Corpus Christi", "El Paso", "San Antonio", "Houston", "Fort Worth")
city_pop = city_pop %>%  mutate(across(2:5, ~ as.numeric(gsub("[^0-9.-]", "", .)))) %>% arrange(desc(1))
city_pop_long = city_pop %>% pivot_longer(-City, names_to = "year", values_to = "population") %>% mutate(year = as.integer(year))
city_pop_long <- rbind(city_pop_long, pop_data_24)
```


```{r}
city_trend_major = city_trend %>% filter(PAT_City %in% major_cities) %>% mutate(PAT_City = factor(PAT_City, levels = major_cities))

city_trend_major = city_trend_major %>% left_join(city_pop_long, by = c("PAT_City" = "City", "year" = "year")) %>% 
  mutate(patients_per_100k = total_patients / population * 100000)
```

```{r, fig.height=15, fig.width=10}
regular = ggplot(city_trend_major, aes(x = quarter, y = total_patients, group = PAT_City)) +
  geom_line(linewidth = 1.2, color = "blue") +
  geom_point(color = "blue") +
  theme_minimal(base_size = 14) +
  labs(title = "Flu Patients Over Time by City", x = "Quarter", y = "Number of Patients", color = "City") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + facet_wrap(~PAT_City, nrow = 8)

normalized = ggplot(city_trend_major, aes(x = quarter, y = patients_per_100k, group = PAT_City)) +
  geom_line(linewidth = 1.2, color = "red") +
  geom_point(color = "red") +
  theme_minimal(base_size = 14) +
  labs(title = "Flu Patients per 100,000 Over Time by City", x = "Quarter", y = "Number of Patients per 100,000", color = "City") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + facet_wrap(~PAT_City, nrow = 8)

regular + normalized

```
# City Health Dashboard
# Temperature
# Flu vaccination rate
# Flu legislation?
# Qualitative data to explain trends
