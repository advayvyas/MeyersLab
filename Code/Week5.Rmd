---
title: "Week 5"
author: "Advay Vyas"
date: "5/6/25"
output:
  pdf_document:
    toc: true
urlcolor: blue
linkcolor: red
---

```{r global_options, echo=FALSE}
knitr::opts_chunk$set(fig.height=8, fig.width=8, fig.align = "center", warning=FALSE, echo=FALSE, tidy=TRUE, tidy.opts=list(width.cutoff=60))
```

------------------------------------------------------------------------

```{r, results='hide', warning=FALSE, message=FALSE}
library(dplyr)
library(tidyverse)
library(ggplot2)
library(lubridate)
library(patchwork)
library(corrplot)
library(mosaic)
```

# Introduction
This week, we are going to conduct multiple linear regression and try to incorporate interaction variables and ANOVA for some additional modeling boosts. The (tentative) indicator variables are flu vaccination coverage rate and uninsured % (from Week 4), temperature (from Week 3), Social Vulnerability Index (SVI) and beds per capita (from Week 2). Since this is my last week until the break ends, I wanted to conduct a sort of final project that would try to tie everything together and hopefully show some real trends from the data that I've web scraped and cleaned.

# The old model
# A new correlation matrix
```{r, warning=FALSE, message=FALSE}
city_trend_major = read.csv("../texas_city_trend_major.csv") 
colnames(city_trend_major) = c("city", "year", "quarter", "total_patients", "population", "patients_per_100k")

first_spike = city_trend_major %>% filter(quarter == "2022Q4") %>% select(city, total_patients, population, patients_per_100k)

city_health = read.csv("../texas_cityhealth.csv") %>% pivot_wider(names_from = Metric, values_from = Value) # 2022
colnames(city_health)[1] = "city"

flu_vax = read.csv("../texas_flu_vax.csv") # 2022

first_spike = first_spike %>% left_join(city_health) %>% left_join(flu_vax[,2:3])
```

```{r, message=FALSE}
corresponding_cities = c(
  "San Antonio",       # Bexar County
  "Dallas",            # Dallas County
  "El Paso",           # El Paso County
  "Houston",           # Harris County
  "Corpus Christi",    # Nueces County
  "Fort Worth", # Tarrant County
  "Austin",          # Travis County
  "Arlington" # Tarrant County again
)

weather = read.csv("../texas_weather.csv") %>% filter(year == 2022) %>% arrange(county)
weather = weather %>% rbind(weather[6,])
weather$city = corresponding_cities

first_spike = first_spike %>% left_join(weather[,c(2,4)])
```

```{r, message = FALSE}
texas_svi = read.csv("../texas_svi.csv")
counties = c("Harris County", "Bexar County", "Dallas County", "Travis County", "Tarrant County", "El Paso County", "Tarrant County", "Nueces County")

texas_svi_major = texas_svi %>% filter(COUNTY %in% counties) %>% select(COUNTY, RPL_THEMES) %>% add_column(City = c(1:7), .before = 2) %>% arrange((RPL_THEMES))

texas_svi_major = texas_svi_major %>% arrange(COUNTY)
texas_svi_major = texas_svi_major %>% rbind(texas_svi_major[6,])
texas_svi_major$city = corresponding_cities
texas_svi_major = texas_svi_major[,3:4]
colnames(texas_svi_major)[1] = "svi_percentile"

first_spike = first_spike %>% left_join(texas_svi_major)
```

```{r, cache=TRUE}
hospitals = read.csv("../COVID-19_Reported_Patient_Impact_and_Hospital_Capacity_by_Facility.csv")
hospitals = hospitals[hospitals$state=="TX",] %>% mutate(city = str_to_title(city))
```

```{r, fig.height=4, fig.width=10}
major_cities = c("Houston", "San Antonio", "Dallas", "Austin", "Fort Worth", "El Paso", "Arlington", "Corpus Christi")

hospitals_major = hospitals %>% filter(city %in% major_cities) %>% mutate(city = factor(city, levels = major_cities))
desired_columns = c("hospital_pk", "collection_week", "hospital_name", "city", "hospital_subtype", "total_beds_7_day_avg", "total_patients_hospitalized_confirmed_influenza_7_day_sum", "total_patients_hospitalized_confirmed_influenza_7_day_avg")

hospitals_major = hospitals_major %>%
  select(all_of(desired_columns)) %>%  
  rename(
    id = hospital_pk,
    week = collection_week,
    name = hospital_name,
    city = city,
    subtype = hospital_subtype,
    beds_avg = total_beds_7_day_avg,
    flu_sum = total_patients_hospitalized_confirmed_influenza_7_day_sum,
    flu_avg = total_patients_hospitalized_confirmed_influenza_7_day_avg) 

hospitals_major = hospitals_major %>% mutate(across(c(beds_avg, flu_sum, flu_avg), ~ifelse(. <= 0, NA, .)))
```

```{r}
weekly_city_data = hospitals_major %>% drop_na(beds_avg) %>% mutate(week = as.Date(week)) %>% group_by(city, week) %>% summarize(total_beds = sum(beds_avg), .groups = "drop")

# gotta clean up this data
city_pop = read.csv("../texas_city_pop.csv")
city_pop = city_pop[c(3:1233), c(1, 3:6)]

names(city_pop) = as.character(city_pop[1, ])
names(city_pop)[1] = "City"
city_pop = city_pop[-1, ]

city_pop = city_pop[c(52, 270, 44, 237, 340, 972, 497, 376),]
city_pop$City = c("Austin", "Dallas", "Arlington", "Corpus Christi", "El Paso", "San Antonio", "Houston", "Fort Worth")
city_pop = city_pop %>%  mutate(across(2:5, ~ as.numeric(gsub("[^0-9.-]", "", .)))) %>% arrange(desc(1))
```

```{r, fig.height = 8, fig.width = 10, message = "false", warning = "false"}
city_pop_long = city_pop %>% pivot_longer(-City, names_to = "year", values_to = "population") %>% mutate(year = as.integer(year))

weekly_city_data_norm = weekly_city_data %>% mutate(year = as.integer(format(week, "%Y"))) %>% left_join(city_pop_long, by = c("city" = "City", "year" = "year")) %>% 
  mutate(beds_per_100k = total_beds / population * 100000) %>% mutate(city = factor(city, levels = major_cities))

avg_beds_2022 <- weekly_city_data_norm %>%
  filter(year == 2022) %>%
  group_by(city) %>%
  summarize(avg_beds_per_100k = mean(beds_per_100k, na.rm = TRUE))

first_spike = first_spike %>% left_join(avg_beds_2022)
```

```{r, fig.height = 7, fig.width = 8}
numeric_data = first_spike[sapply(first_spike, is.numeric)]
cor_matrix = cor(numeric_data)
corrplot.mixed(cor_matrix, tl.col = "black", tl.pos = "lt", addgrid.col = TRUE, upper="color", lower="number", diag="l")
```

# The new model
## Adding flu vaccination coverage rate
## Adding insurance coverage percentage
## Adding temperature data
## Adding SVI data
## Adding beds per capita

# ANOVA
## Results
## Analysis

# Conclusion
## Week 5
## Looking forward
What a ride! For how short this was, it was honestly great.