---
title: "Week 4"
author: "Advay Vyas"
date: "4/29/25"
output:
  pdf_document:
    toc: true
urlcolor: blue
linkcolor: red
---

```{r global_options, echo=FALSE}
knitr::opts_chunk$set(fig.height=8, fig.width=8, fig.align = "center", warning=FALSE, echo=FALSE, tidy=TRUE, tidy.opts=list(width.cutoff=60))
```

------------------------------------------------------------------------

```{r, results='hide', warning=FALSE, message=FALSE}
library(dplyr)
library(tidyverse)
library(ggplot2)
library(lubridate)
library(patchwork)
library(corrplot)
library(mosaic)
```

# Introduction
This week, we are going to look into vaccination and quantify the correlation between vaccination and flu patients. We will also attempt to look at the new datasets for specifically flu patients and maybe make a correlation matrix to find any variables that match up well. Also, we want to look into why cities like Dallas have much higher flu patients per capita compared to ciites like Austin. We can also look at why cities like Houston and San Antonio have different numbers every cycle.

\newpage

# Flu spikes
```{r}
city_trend_major = read.csv("../texas_city_trend_major.csv") 
colnames(city_trend_major) = c("city", "year", "quarter", "total_patients", "population", "patients_per_100k")
```

## Isolating the seasonal spikes
```{r, fig.height=6, fig.width=12}
ggplot(city_trend_major, aes(x = quarter, y = patients_per_100k, group = city, color = city)) +
  geom_line(linewidth = 1,) +
  geom_point() +
  labs(title = "Flu patients per 100,000 over time by city", x = "Quarter", y = "Patients per 100,000", color = "City") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + theme_bw()
```
We can clearly see that the peaks of each season ("spikes") are at 2022Q4 and 2024Q1. Now, let's grab those specific values from the first and second spike to run statistical analysis on. I'd like to preface by saying that the correlation matrix will be much more accurate for 2022 since I only have 2022 data for city health and flu vaccination coverage.

\newpage

## Comparing each spike
```{r}
first_spike = city_trend_major %>% filter(quarter == "2022Q4") %>% select(city, total_patients, population, patients_per_100k)
second_spike = city_trend_major %>% filter(quarter == "2024Q1") %>% select(city, total_patients, population, patients_per_100k)
```

Let's get some bar graph representations of our data so we can interpret it a little better.
```{r, fig.height = 7, fig.width = 8}
first = ggplot(first_spike) + geom_col(aes(x = reorder(city, patients_per_100k), y = patients_per_100k), fill = "skyblue", col="black") + 
  labs(title = "Flu Patients per 100,000 during First Spike (2022 Q4)", x = "City", y = "Flu Patients per 100,000") + theme_bw()

second = ggplot(second_spike) + geom_col(aes(x = reorder(city, patients_per_100k), y = patients_per_100k), fill = "skyblue", col="black") + 
  labs(title = "Flu Patients per 100,000 during First Spike (2024 Q1)", x = "City", y = "Flu Patients per 100,000") + theme_bw()
first / second
```
Looks like small changes in each spike, but Austin has the least both times (this aligns with what we saw last week). Now, let's compare the spikes side by side to get a better feel.

```{r, fig.height = 4, fig.width = 8}
ggplot(city_trend_major %>% filter(quarter == "2022Q4" | quarter == "2024Q1")) + geom_col(aes(x = reorder(city, patients_per_100k), y = patients_per_100k, fill = quarter), position = position_dodge2(preserve = "single"), col="black") + 
  labs(title = "Flu Patients per 100,000 during Spikes", x = "City", y = "Flu Patients per 100,000", fill = "Quarter") + theme_bw()
```
I don't see any specific trend with 2022 vs. 2024 (technically end of 2023, maybe it was just a late flu season). Austin and Dallas look about even both times, El Paso, San Antonio, Corpus Christi, and Arlington all increased while Fort Worth and Houston decreased - could look into why that is.

# Correlation with other variables
```{r, warning=FALSE, message=FALSE}
city_health = read.csv("../texas_cityhealth.csv") %>% pivot_wider(names_from = Metric, values_from = Value) # 2022
colnames(city_health)[1] = "city"

flu_vax = read.csv("../texas_flu_vax.csv") # 2022

first_spike = first_spike %>% left_join(city_health) %>% left_join(flu_vax[,2:3])
```

## Correlation matrix
```{r, fig.height = 7, fig.width = 7}
numeric_data = first_spike[sapply(first_spike, is.numeric)]
cor_matrix = cor(numeric_data)
corrplot.mixed(cor_matrix, tl.col = "black", tl.pos = "lt", addgrid.col = TRUE, upper="color", lower="number", diag="l")
```
Above is the correlation matrix for City Health metrics, flu vaccination data, and patients per 100,000 for the first spike (2022Q4). We're looking for high correlation values with patients per 100k, which we see from Routine Checkups (%) at 0.51, Uninsured (%) at 0.44, and coverage_rate at -0.55.

\newpage

## Vaccination coverage rate
Note that for the coverage rate graph, the trend would be even stronger if Fort Worth and Arlington didn't share the same coverage rate by virtue of being in the same county - this first graph shows a very strong trend. 
```{r, fig.height = 3, fig.width = 7, message=FALSE}
ggplot(first_spike, aes(x=coverage_rate, y=patients_per_100k, col=city)) + geom_point(size=2) + 
  geom_smooth(method = "lm", col = "black", se=FALSE) + 
  labs(title = "Vaccination Coverage Rate vs. Flu Patients per 100,000", x="Coverage Rate", y="Patients per 100,000", col = "City") + theme_bw()
```
In fact, removing those two cities results in a correlation of -0.75.
```{r, fig.height = 3, fig.width = 7, message=FALSE}
ggplot(first_spike[c(2:5,7:8),], aes(x=coverage_rate, y=patients_per_100k, col=city)) + geom_point(size=2) + 
  geom_smooth(method = "lm", col = "black", se=FALSE) + 
  labs(title = "Vaccination Coverage Rate vs. Flu Patients per 100,000", x="Coverage Rate", y="Patients per 100,000", col = "City") + theme_bw()
```
\newpage

## Routine checkups
This graph kind of destroys any correlation this has because Austin "anchors" this line to have a positive slope. Furthermore, Austin actually has the least amount of Routine Checkup (%) so we should expect this graph to have a negative slope (more checkups means less patients). 
```{r, fig.height = 3, fig.width = 7, message=FALSE}
ggplot(first_spike, aes(x=`Routine Checkup (%)`, y=patients_per_100k, col=city)) + geom_point(size=2) + 
  geom_smooth(method = "lm", col = "black", se=FALSE) +
  labs(title = "Routine Checkup (%) vs. Flu Patients per 100,000", x=  "Routine Checkup (%)", y ="Patients per 100,000", col = "City") + theme_bw()
```
Let's try this graph without Austin and see what we get. This graph makes a lot more sense, not sure how accurate it is - we get a correlation of -0.51 after removing Austin (an upgrade over the previous 0.51, ironically just a flipped sign).
```{r, fig.height = 3, fig.width = 7, message=FALSE}
ggplot(first_spike[c(1,3:8),], aes(x=`Routine Checkup (%)`, y=patients_per_100k, col=city)) + geom_point(size=2) + 
  geom_smooth(method = "lm", col = "black", se=FALSE) +
  labs(title = "Routine Checkup (%) vs. Flu Patients per 100,000 w/out Austin", x=  "Routine Checkup (%)", 
       y ="Patients per 100,000", col = "City") + theme_bw()
```
\newpage

## Insurance
This variable looks like a general trend again anchored by Austin being very low. This time, the trend appears to make sense since less uninsured people should lead to less flu patients.
```{r, fig.height = 3, fig.width = 7, message=FALSE}
ggplot(first_spike, aes(x=`Uninsured (%)`, y=patients_per_100k, col=city)) + geom_point(size=2) + 
  geom_smooth(method = "lm", col = "black", se=FALSE) +
  labs(title = "Uninsured (%) vs. Flu Patients per 100,000", x = "Uninsured (%)", y = "Patients per 100,000", col = "City") + theme_bw()
```
Aha! Without Austin, the correlation vanishes and is back to the wrong signed slope. I definitely don't see a trend here, for what it's worth. 
```{r, fig.height = 3, fig.width = 7, message=FALSE}
ggplot(first_spike[c(1,3:8),], aes(x=`Uninsured (%)`, y=patients_per_100k, col=city)) + geom_point(size=2) + 
  geom_smooth(method = "lm", col = "black", se=FALSE) +
  labs(title = "Uninsured (%) vs. Flu Patients per 100,000", x = "Uninsured (%)", y = "Patients per 100,000", col = "City") + theme_bw()
```
\newpage
## Analysis
```{r, cache = TRUE}
coverage_boot = do(10000) * {
  model = lm(patients_per_100k ~ coverage_rate, data = mosaic::resample(first_spike))
  coef(model)[2]
}
```

From this correlation matrix, I think we have sufficiently proved that vaccination coverage rate is absolutely crucial to understanding how many flu patients appear (at least in the 2022 spike). Furthermore, we can train a linear regression model and bootstrap the coefficient to get `r round(mean(coverage_boot$coverage_rate), 2)` as implying that with every 1% increase in flu vaccination coverage rate, the number of flu patients per 100,000 reduces by around 2.

```{r, fig.height = 3, fig.width = 6}
ggplot(coverage_boot) + geom_histogram(aes(x=coverage_rate), color = "black", fill = "skyblue", bins=50) + 
  geom_vline(xintercept=mean(coverage_boot$coverage_rate), color = "red") + 
  labs(title = "Bootstrapped sampling distribution of coverage_rate coefficient", x = "coverage_rate", y = "Frequency") + theme_bw()
```

```{r, cache = TRUE}
checkup_boot = do(10000) * {
  model = lm(patients_per_100k ~ `Routine Checkup (%)`, data = mosaic::resample(first_spike[c(1,3:8),]))
  coef(model)[2]
}

names(checkup_boot)[1] = "routine_checkup"
checkup_boot = na.omit(checkup_boot)
```

For cities that are not Austin, the routine checkup % seems to make a difference, with more routine checkups implying less flu patients. We'll now do the same bootstrapping as before for this variable, except this time around we only resample from cities that are not Austin. Now, we get the value `r round(mean(checkup_boot$routine_checkup), 2)` as implying that with every 1% increase in the percent of the population that get routine checkups, the number of flu patients per 100,000 reduces by around 6 to 7.

```{r, fig.height = 3, fig.width = 6}
ggplot(checkup_boot) + geom_histogram(aes(x=routine_checkup), color = "black", fill = "skyblue", bins=50) + 
  geom_vline(xintercept=mean(checkup_boot$routine_checkup), color = "red") + 
  labs(title = "Bootstrapped sampling distribution of routine_checkup coefficient", x = "routine_checkup", y = "Frequency") + theme_bw()
```

Lastly, uninsured % seems to have no substantial difference, so we ignore this.

# City comparisons
## Dallas vs. Austin
### Vaccination coverage
The defining factor in this comparison is the flu vaccination coverage rate, which is 42.5% for Austin and 39.9% for Dallas. Given that Dallas has a larger population by about a quarter of a million, this is a significant gap in flu patients and still a gap in patients per 100,000.

### Demographics
Austin tends to have a younger population than Dallas, which could also explain the lack of flu patients since younger people would be less likely to check into a hospital for influenza.

### Politics
Austin is significantly more Democratic-leaning (blue) than Dallas, which might explain the higher vaccination coverage numbers.

## Important changes in major Texas cities (2022-2024)
### Healthcare Access

**2022**

Emergency departments and urgent care centers across major metros were overcrowded due to simultaneous surges of influenza, COVID‑19, and RSV.

Travis County clinics in Austin saw influenza‑like illness visits spike in October 2022—the earliest flu season start since at least 2018 - straining local healthcare capacity. (https://www.axios.com/local/austin/2022/12/06/covid-19-flu-rsv-rise-austin).

In Houston, approximately 7% of all patient visits in mid‑November 2022 were influenza diagnoses, significantly straining local ER capacity.(https://www.axios.com/local/houston/2022/12/07/flu-cases-houston)

**2023**

Texas Health Resources expanded free flu vaccination services through its Faith Community Nursing and Health Promotion program, delivering no‑cost vaccines in underserved neighborhoods via houses of worship and pop‑up clinics.(https://www.texashealth.org/About-Texas-Health/Community-Update/Fighting-the-Flu)

The CDC’s Vaccines for Children (VFC) grants awarded \$100,000 to the City of Houston and \$135,299 to the City of San Antonio, enhancing immunization infrastructure and outreach. (https://fundingprofiles.cdc.gov/Report_Docs/PDFDocs/Rpt2023/Texas-2023-CDC-Grants-Profile-Report.pdf)

### Politics and Policy

**2022**

Statewide executive orders and Texas Supreme Court rulings prohibited local mask mandates, preventing individual cities from imposing mask requirements during peak influenza activity, thereby limiting non‑pharmaceutical interventions. (https://www.texastribune.org/2023/06/30/texas-supreme-court-greg-abbott-covid-masks/)

**2023**

House Bill 321, aimed at streamlining Medicaid and CHIP enrollment for children to improve access to vaccines and care, failed to pass despite bipartisan support, extending coverage gaps for low‑income families in cities such as Dallas and Houston.(https://capitol.texas.gov/tlodocs/89R/analysis/html/HB00321H.htm)

### Demographics

**2022**

Pediatric hospitalizations surged early in the season in both Austin and Houston, overwhelming pediatric units. Approximately 11% of Texas children were uninsured, with underinsurance disproportionately affecting Hispanic communities. (https://publichealthwatch.org/2025/02/26/texas-health-uninsured-children-medicaid/)

**2023**

Uninsured rates rose to over 25% among Hispanic Texans and nearly 12% for children statewide, with the highest concentrations in Houston, Dallas, and San Antonio. (https://www.texastribune.org/2025/05/01/texas-hispanics-covid-19-deaths/)

No influenza‑associated pediatric deaths were reported, and fewer school‑based outbreaks occurred in Dallas and Travis counties, reflecting improved vaccine uptake and targeted school outreach. (https://www.dallascounty.org/Assets/uploads/docs/hhs/influenza-surveillance/2023/Influenza%20Weekly%20Report%20Week%20ending%2012-30-2023.pdf)

# Conclusion
Our analysis indicates that flu vaccination coverage rate is the strongest predictor of flu patient incidence across Texas cities, particularly during the 2022 seasonal spike. A higher vaccination rate consistently correlates with fewer flu patients per 100,000 residents, and this relationship is supported by both visual trends and statistical analysis, including a bootstrapped regression coefficient suggesting that each 1% increase in coverage reduces flu incidence by approximately 2 cases per 100,000.

Routine checkup percentage appears to have a moderate inverse relationship with flu incidence, but this signal becomes clearer only when excluding Austin, which is an outlier due to its unusually low checkup rate yet low flu incidence. After excluding Austin, we estimate that a 1% increase in routine checkup rates corresponds to roughly 6–7 fewer flu cases per 100,000.

In contrast, the percentage of uninsured individuals shows little to no consistent correlation with flu incidence, especially after accounting for city-level outliers. This suggests that while access to insurance is an important public health concern, it may not be a primary driver of flu hospitalization rates at the city level.

City comparisons highlight meaningful differences, with Austin consistently showing lower flu rates than cities like Dallas. These differences may be attributed not only to higher vaccination rates but also to demographic, political, and healthcare infrastructure differences. Policy shifts, such as improved outreach and vaccine funding in Houston and San Antonio, may also have contributed to changes in flu incidence over time.

Overall, increasing flu vaccination coverage appears to be the most effective lever for reducing flu-related healthcare burdens across Texas cities, followed by improved access to routine preventive care.